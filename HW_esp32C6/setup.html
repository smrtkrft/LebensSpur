<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0a0a0a">
    <title>LebensSpur - Setup</title>
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #141414;
            --bg-tertiary: #1a1a1a;
            --border-default: #2a2a2a;
            --border-subtle: #1f1f1f;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --text-tertiary: #666666;
            --accent-primary: #2563eb;
            --accent-success: #059669;
            --accent-warning: #d97706;
            --accent-danger: #dc2626;
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-full: 9999px;
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 20px;
            --space-6: 24px;
            --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --font-mono: 'SF Mono', Monaco, 'Cascadia Code', monospace;
        }
        
        html { font-size: 16px; }
        body {
            font-family: var(--font-sans);
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-4);
        }
        
        .setup-container {
            width: 100%;
            max-width: 480px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }
        
        .setup-header {
            padding: var(--space-6);
            text-align: center;
            border-bottom: 1px solid var(--border-subtle);
        }
        .setup-logo {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            margin-bottom: var(--space-1);
        }
        .setup-subtitle {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        .steps-indicator {
            display: flex;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-4);
            background: var(--bg-tertiary);
        }
        .step-dot {
            width: 10px;
            height: 10px;
            border-radius: var(--radius-full);
            background: var(--border-default);
            transition: all 0.3s ease;
        }
        .step-dot.active { background: var(--accent-primary); transform: scale(1.2); }
        .step-dot.completed { background: var(--accent-success); }
        
        .setup-content {
            padding: var(--space-6);
            min-height: 320px;
            display: flex;
            flex-direction: column;
        }
        .step-panel { display: none; flex-direction: column; flex: 1; }
        .step-panel.active { display: flex; }
        
        .step-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: var(--space-2);
            text-align: center;
        }
        .step-desc {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: var(--space-6);
        }
        
        .form-group { margin-bottom: var(--space-4); }
        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: var(--space-2);
            color: var(--text-secondary);
        }
        .form-input {
            width: 100%;
            padding: var(--space-3);
            background: var(--bg-primary);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: var(--font-mono);
            font-size: 16px; /* Prevent iOS zoom on focus */
            -webkit-appearance: none;
            touch-action: manipulation;
        }
        .form-input:focus { outline: none; border-color: var(--accent-primary); }
        .form-input::placeholder { color: var(--text-tertiary); }
        .form-hint {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            margin-top: var(--space-1);
        }
        
        .wifi-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-default);
            border-radius: var(--radius-sm);
            margin-bottom: var(--space-4);
        }
        .wifi-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-3);
            border-bottom: 1px solid var(--border-subtle);
            cursor: pointer;
            transition: background 0.2s;
        }
        .wifi-item:last-child { border-bottom: none; }
        .wifi-item:hover { background: var(--bg-tertiary); }
        .wifi-item.selected { background: var(--bg-tertiary); border-left: 2px solid var(--text-primary); }
        .wifi-name { font-size: 0.875rem; }
        .wifi-signal {
            display: flex;
            gap: 2px;
            align-items: flex-end;
        }
        .wifi-bar {
            width: 3px;
            background: var(--border-default);
            border-radius: 1px;
        }
        .wifi-bar.active { background: var(--text-secondary); }
        .wifi-scan-btn {
            width: 100%;
            padding: var(--space-2);
            background: transparent;
            border: 1px dashed var(--border-default);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 0.875rem;
            cursor: pointer;
            margin-bottom: var(--space-4);
        }
        .wifi-scan-btn:hover { border-color: var(--text-tertiary); color: var(--text-primary); }
        
        .password-strength {
            display: flex;
            gap: var(--space-1);
            margin-top: var(--space-2);
        }
        .strength-bar {
            flex: 1;
            height: 4px;
            background: var(--border-default);
            border-radius: var(--radius-full);
        }
        .strength-bar.weak { background: var(--accent-danger); }
        .strength-bar.medium { background: var(--accent-warning); }
        .strength-bar.strong { background: var(--accent-success); }
        .strength-text {
            font-size: 0.75rem;
            margin-top: var(--space-1);
        }
        .strength-text.weak { color: var(--accent-danger); }
        .strength-text.medium { color: var(--accent-warning); }
        .strength-text.strong { color: var(--accent-success); }
        
        .update-status {
            text-align: center;
            padding: var(--space-6);
        }
        .update-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto var(--space-4);
            border-radius: var(--radius-full);
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .update-icon svg { width: 32px; height: 32px; color: var(--text-secondary); }
        .update-icon.loading svg { animation: spin 1s linear infinite; }
        .update-icon.success svg { color: var(--accent-success); }
        .update-icon.error svg { color: var(--accent-danger); }
        
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-full);
            overflow: hidden;
            margin: var(--space-4) 0;
        }
        .progress-fill {
            height: 100%;
            background: var(--accent-primary);
            border-radius: var(--radius-full);
            transition: width 0.3s ease;
        }
        .progress-text {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .update-source {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-3);
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            color: var(--text-tertiary);
            margin-top: var(--space-4);
        }
        .update-source svg { width: 16px; height: 16px; }
        
        .setup-footer {
            display: flex;
            gap: var(--space-3);
            padding: var(--space-4) var(--space-6);
            border-top: 1px solid var(--border-subtle);
            background: var(--bg-tertiary);
        }
        .btn {
            flex: 1;
            padding: var(--space-3) var(--space-4);
            border: none;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-ghost {
            background: transparent;
            border: 1px solid var(--border-default);
            color: var(--text-secondary);
        }
        .btn-ghost:hover { border-color: var(--text-tertiary); color: var(--text-primary); }
        .btn-primary {
            background: var(--accent-primary);
            color: white;
        }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-primary:disabled {
            background: var(--border-default);
            color: var(--text-tertiary);
            cursor: not-allowed;
        }
        .btn-success {
            background: var(--accent-success);
            color: white;
        }
        
        .info-box {
            display: flex;
            align-items: flex-start;
            gap: var(--space-3);
            padding: var(--space-3);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-sm);
            margin-bottom: var(--space-4);
        }
        .info-box svg { flex-shrink: 0; width: 18px; height: 18px; color: var(--text-tertiary); }
        .info-box p { font-size: 0.75rem; color: var(--text-secondary); line-height: 1.5; }
        
        .success-screen {
            text-align: center;
            padding: var(--space-6);
        }
        .success-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto var(--space-4);
            border-radius: var(--radius-full);
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .success-icon svg { width: 40px; height: 40px; color: var(--accent-success); }
        .success-title { font-size: 1.5rem; font-weight: 600; margin-bottom: var(--space-2); }
        .success-desc { color: var(--text-secondary); margin-bottom: var(--space-6); }
        .device-info {
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            padding: var(--space-4);
            text-align: left;
        }
        .device-row {
            display: flex;
            justify-content: space-between;
            padding: var(--space-2) 0;
            border-bottom: 1px solid var(--border-subtle);
            font-size: 0.875rem;
        }
        .device-row:last-child { border-bottom: none; }
        .device-label { color: var(--text-tertiary); }
        .device-value { color: var(--text-primary); font-family: var(--font-mono); }
        
        @media (max-width: 480px) {
            .setup-container { border-radius: 0; border-left: none; border-right: none; }
        }
    </style>
</head>
<body>
    <div class="setup-container">
        <div class="setup-header">
            <div class="setup-logo">LebensSpur</div>
            <div class="setup-subtitle">Initial Setup</div>
        </div>
        
        <div class="steps-indicator">
            <div class="step-dot active" data-step="1"></div>
            <div class="step-dot" data-step="2"></div>
            <div class="step-dot" data-step="3"></div>
        </div>
        
        <div class="setup-content">
            
            <!-- Step 1: WiFi Settings -->
            <div class="step-panel active" id="step1">
                <h2 class="step-title">WiFi Connection</h2>
                <p class="step-desc">Select a WiFi network for internet access</p>
                
                <button class="wifi-scan-btn" id="scanWifiBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; vertical-align: middle; margin-right: 8px;">
                        <path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path>
                        <path d="M22 12A10 10 0 0 0 12 2v10z"></path>
                    </svg>
                    Scan Networks
                </button>
                
                <div class="wifi-list" id="wifiList">
                    <!-- Networks will be populated by WiFi scan -->
                </div>
                
                <div class="form-group">
                    <label class="form-label">Network Name (SSID)</label>
                    <input type="text" class="form-input" id="wifiSsid" placeholder="Enter manually or select above">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="wifiPassword" placeholder="WiFi password">
                </div>
            </div>
            
            <!-- Step 2: Device Password -->
            <div class="step-panel" id="step2">
                <h2 class="step-title">Device Password</h2>
                <p class="step-desc">Set a password for web panel access</p>
                
                <div class="info-box">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="16" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                    </svg>
                    <p>This password will be used to access your device via web interface. A strong password is recommended.</p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="devicePassword" placeholder="Enter password">
                    <div class="password-strength" id="passwordStrength">
                        <div class="strength-bar"></div>
                        <div class="strength-bar"></div>
                        <div class="strength-bar"></div>
                        <div class="strength-bar"></div>
                    </div>
                    <p class="strength-text" id="strengthText"></p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Confirm Password</label>
                    <input type="password" class="form-input" id="devicePasswordConfirm" placeholder="Re-enter password">
                    <p class="form-hint" id="passwordMatch"></p>
                </div>
            </div>
            
            <!-- Step 3: GUI Update -->
            <div class="step-panel" id="step3">
                <h2 class="step-title">Interface Update</h2>
                <p class="step-desc">Web interface will be downloaded from GitHub</p>
                
                <div class="update-status" id="updateStatus">
                    <div class="update-icon" id="updateIcon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                    </div>
                    <p class="progress-text" id="updateText">Ready to start update</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                    </div>
                    <p class="progress-text" id="progressPercent">0%</p>
                </div>
                
                <div class="update-source">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                    </svg>
                    <span>smrtkrft/LebensSpur</span>
                </div>
            </div>
            
            <!-- Success Step -->
            <div class="step-panel" id="stepSuccess">
                <div class="success-screen">
                    <div class="success-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </div>
                    <h2 class="success-title">Setup Complete!</h2>
                    <p class="success-desc">Your device is ready to use</p>
                    
                    <div class="device-info">
                        <div class="device-row">
                            <span class="device-label">Device ID</span>
                            <span class="device-value" id="finalDeviceId">LS-12SE4F6K32</span>
                        </div>
                        <div class="device-row">
                            <span class="device-label">WiFi</span>
                            <span class="device-value" id="finalWifi">MyNetwork</span>
                        </div>
                        <div class="device-row">
                            <span class="device-label">IP Address</span>
                            <span class="device-value" id="finalIp">192.168.1.105</span>
                        </div>
                        <div class="device-row">
                            <span class="device-label">mDNS</span>
                            <span class="device-value" id="finalMdns">LS-12SE4F6K32.local</span>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
        
        <div class="setup-footer">
            <button class="btn btn-ghost" id="prevBtn" style="display: none;">Back</button>
            <button class="btn btn-primary" id="nextBtn">Continue</button>
        </div>
    </div>
    
    <script>
        const state = {
            currentStep: 1,
            totalSteps: 3,
            wifiSsid: '',
            wifiPassword: '',
            devicePassword: '',
            isUpdating: false,
            updateCompleted: false,
            wifiConnected: false,
            deviceInfo: null
        };
        
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const stepDots = document.querySelectorAll('.step-dot');
        
        document.addEventListener('DOMContentLoaded', init);
        
        async function init() {
            // WiFi item click handlers
            document.querySelectorAll('.wifi-item').forEach(item => {
                item.addEventListener('click', () => {
                    document.querySelectorAll('.wifi-item').forEach(i => i.classList.remove('selected'));
                    item.classList.add('selected');
                    document.getElementById('wifiSsid').value = item.dataset.ssid;
                    state.wifiSsid = item.dataset.ssid;
                });
            });
            
            document.getElementById('scanWifiBtn').addEventListener('click', scanWifi);
            document.getElementById('devicePassword').addEventListener('input', checkPasswordStrength);
            document.getElementById('devicePasswordConfirm').addEventListener('input', checkPasswordMatch);
            
            prevBtn.addEventListener('click', prevStep);
            nextBtn.addEventListener('click', nextStep);
            
            // Enter key: WiFi password → Continue, Device password confirm → Continue
            document.getElementById('wifiPassword').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') { e.preventDefault(); nextBtn.click(); }
            });
            document.getElementById('devicePasswordConfirm').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') { e.preventDefault(); nextBtn.click(); }
            });
            
            // İlk WiFi taramasını yap
            await scanWifi();
            
            // Device info al
            try {
                const r = await fetch('/api/device/info');
                if (r.ok) state.deviceInfo = await r.json();
            } catch(e) {}
            
            updateUI();
        }
        
        function updateUI() {
            stepDots.forEach((dot, index) => {
                dot.classList.remove('active', 'completed');
                if (index + 1 < state.currentStep) {
                    dot.classList.add('completed');
                } else if (index + 1 === state.currentStep) {
                    dot.classList.add('active');
                }
            });
            
            document.querySelectorAll('.step-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            
            if (state.currentStep <= state.totalSteps) {
                document.getElementById(`step${state.currentStep}`).classList.add('active');
            } else {
                document.getElementById('stepSuccess').classList.add('active');
            }
            
            prevBtn.style.display = state.currentStep > 1 && state.currentStep <= state.totalSteps ? '' : 'none';
            
            if (state.currentStep === state.totalSteps) {
                nextBtn.textContent = state.updateCompleted ? 'Finish Setup' : 'Start Update';
            } else if (state.currentStep > state.totalSteps) {
                nextBtn.textContent = 'Open Panel';
                nextBtn.classList.remove('btn-primary');
                nextBtn.classList.add('btn-success');
                prevBtn.style.display = 'none';
            } else {
                nextBtn.textContent = 'Continue';
            }
        }
        
        function prevStep() {
            if (state.currentStep > 1) {
                state.currentStep--;
                updateUI();
            }
        }
        
        async function nextStep() {
            if (state.currentStep > state.totalSteps) {
                window.location.href = '/';
                return;
            }
            
            nextBtn.disabled = true;
            const valid = await validateStep();
            nextBtn.disabled = false;
            
            if (!valid) return;
            
            state.currentStep++;
            updateUI();
        }
        
        async function validateStep() {
            switch (state.currentStep) {
                case 1: // WiFi - bağlantı kur
                    const ssid = document.getElementById('wifiSsid').value.trim();
                    const pass = document.getElementById('wifiPassword').value;
                    if (!ssid) {
                        alert('Please select or enter a WiFi network');
                        return false;
                    }
                    state.wifiSsid = ssid;
                    state.wifiPassword = pass;
                    
                    // WiFi bağlantısını başlat (async)
                    try {
                        nextBtn.textContent = 'Connecting...';
                        const r = await fetch('/api/setup/wifi/connect', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ssid: ssid, password: pass})
                        });
                        const d = await r.json();
                        if (!d.success) {
                            alert('Failed to start WiFi connection: ' + (d.error || 'Unknown error'));
                            nextBtn.textContent = 'Continue';
                            return false;
                        }
                        
                        // Bağlantı başlatıldı, şimdi durumu kontrol et (polling)
                        let connected = false;
                        for (let i = 0; i < 25; i++) { // 25 saniye bekle
                            await new Promise(resolve => setTimeout(resolve, 1500));
                            nextBtn.textContent = `Connecting... ${i+1}s`;
                            try {
                                const controller = new AbortController();
                                const timeoutId = setTimeout(() => controller.abort(), 3000);
                                const statusR = await fetch('/api/wifi/status', { signal: controller.signal });
                                clearTimeout(timeoutId);
                                const statusD = await statusR.json();
                                if (statusD.connected) {
                                    connected = true;
                                    break;
                                }
                            } catch(e) {
                                // AP kanal değiştirmiş olabilir, devam et
                                console.log('Status check failed, retrying...', e.message);
                            }
                        }
                        
                        if (connected) {
                            state.wifiConnected = true;
                            nextBtn.textContent = 'Continue';
                            return true;
                        } else {
                            alert('WiFi connection timeout. Please check password and try again.');
                            nextBtn.textContent = 'Continue';
                            return false;
                        }
                    } catch(e) {
                        alert('WiFi connection error: ' + e.message);
                        nextBtn.textContent = 'Continue';
                        return false;
                    }
                    
                case 2: // Password - kaydet
                    const pwd = document.getElementById('devicePassword').value;
                    const pwdConfirm = document.getElementById('devicePasswordConfirm').value;
                    if (pwd.length < 1) {
                        alert('Password cannot be empty');
                        return false;
                    }
                    if (pwd !== pwdConfirm) {
                        alert('Passwords do not match');
                        return false;
                    }
                    state.devicePassword = pwd;
                    
                    // Şifreyi kaydet
                    try {
                        nextBtn.textContent = 'Saving...';
                        const r = await fetch('/api/setup/password', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({password: pwd})
                        });
                        const d = await r.json();
                        if (!d.success) {
                            alert('Failed to save password');
                            nextBtn.textContent = 'Continue';
                            return false;
                        }
                        nextBtn.textContent = 'Continue';
                    } catch(e) {
                        alert('Error saving password: ' + e.message);
                        nextBtn.textContent = 'Continue';
                        return false;
                    }
                    return true;
                    
                case 3: // Update
                    if (state.isUpdating) return false;
                    if (!state.updateCompleted) {
                        startUpdate();
                        return false;
                    }
                    return true;
            }
            return true;
        }
        
        async function scanWifi() {
            const btn = document.getElementById('scanWifiBtn');
            const list = document.getElementById('wifiList');
            
            btn.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; vertical-align: middle; margin-right: 8px; animation: spin 1s linear infinite;">
                    <path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path>
                    <path d="M22 12A10 10 0 0 0 12 2v10z"></path>
                </svg>
                Scanning...
            `;
            
            try {
                const r = await fetch('/api/setup/wifi/scan');
                const d = await r.json();
                
                if (d.networks && d.networks.length > 0) {
                    list.innerHTML = d.networks.map(n => `
                        <div class="wifi-item" data-ssid="${n.ssid}" onclick="selectWifi(this)">
                            <span class="wifi-name">${n.ssid}</span>
                            <div class="wifi-signal">
                                ${renderSignalBars(n.rssi)}
                            </div>
                        </div>
                    `).join('');
                } else {
                    list.innerHTML = '<div style="padding:16px;text-align:center;color:var(--text-tertiary)">No networks found</div>';
                }
            } catch(e) {
                console.error('WiFi scan error:', e);
                list.innerHTML = '<div style="padding:16px;text-align:center;color:var(--accent-danger)">Scan failed</div>';
            }
            
            btn.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; vertical-align: middle; margin-right: 8px;">
                    <path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path>
                    <path d="M22 12A10 10 0 0 0 12 2v10z"></path>
                </svg>
                Scan Networks
            `;
        }
        
        function renderSignalBars(rssi) {
            const strength = rssi > -50 ? 4 : rssi > -60 ? 3 : rssi > -70 ? 2 : 1;
            let bars = '';
            for (let i = 1; i <= 4; i++) {
                const active = i <= strength ? 'active' : '';
                const height = 6 + (i - 1) * 4;
                bars += `<div class="wifi-bar ${active}" style="height: ${height}px;"></div>`;
            }
            return bars;
        }
        
        function selectWifi(el) {
            document.querySelectorAll('.wifi-item').forEach(i => i.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('wifiSsid').value = el.dataset.ssid;
            state.wifiSsid = el.dataset.ssid;
        }
        
        function checkPasswordStrength() {
            const password = document.getElementById('devicePassword').value;
            const bars = document.querySelectorAll('.strength-bar');
            const text = document.getElementById('strengthText');
            
            let strength = 0;
            if (password.length >= 8) strength++;
            if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength++;
            if (password.match(/\d/)) strength++;
            if (password.match(/[^a-zA-Z\d]/)) strength++;
            
            bars.forEach((bar, i) => {
                bar.classList.remove('weak', 'medium', 'strong');
                if (i < strength) {
                    if (strength <= 1) bar.classList.add('weak');
                    else if (strength <= 2) bar.classList.add('medium');
                    else bar.classList.add('strong');
                }
            });
            
            text.className = 'strength-text';
            if (password.length === 0) {
                text.textContent = '';
            } else if (strength <= 1) {
                text.textContent = 'Weak password';
                text.classList.add('weak');
            } else if (strength <= 2) {
                text.textContent = 'Medium strength';
                text.classList.add('medium');
            } else {
                text.textContent = 'Strong password';
                text.classList.add('strong');
            }
            
            checkPasswordMatch();
        }
        
        function checkPasswordMatch() {
            const pwd = document.getElementById('devicePassword').value;
            const confirm = document.getElementById('devicePasswordConfirm').value;
            const hint = document.getElementById('passwordMatch');
            
            if (confirm.length === 0) {
                hint.textContent = '';
                hint.style.color = '';
            } else if (pwd === confirm) {
                hint.textContent = '✓ Passwords match';
                hint.style.color = 'var(--accent-success)';
            } else {
                hint.textContent = '✗ Passwords do not match';
                hint.style.color = 'var(--accent-danger)';
            }
        }
        
        async function startUpdate() {
            state.isUpdating = true;
            nextBtn.disabled = true;
            prevBtn.style.display = 'none';
            
            const icon = document.getElementById('updateIcon');
            const text = document.getElementById('updateText');
            const progressFill = document.getElementById('progressFill');
            const progressPercent = document.getElementById('progressPercent');
            
            function setProgress(pct, msg) {
                progressFill.style.width = pct + '%';
                progressPercent.textContent = pct + '%';
                text.textContent = msg;
            }
            
            function setIcon(type) {
                icon.classList.remove('loading', 'success', 'error');
                if (type === 'loading') {
                    icon.classList.add('loading');
                    icon.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>`;
                } else if (type === 'success') {
                    icon.classList.add('success');
                    icon.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
                } else if (type === 'error') {
                    icon.classList.add('error');
                    icon.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;
                }
            }
            
            setIcon('loading');
            
            try {
                // Step 1: Check WiFi connection
                setProgress(10, 'Checking WiFi connection...');
                const wifiStatus = await fetch('/api/wifi/status');
                const wifiData = await wifiStatus.json();
                if (!wifiData.connected) {
                    throw new Error('WiFi not connected');
                }
                
                // Step 2: Start GUI download
                setProgress(20, 'Connecting to GitHub...');
                await new Promise(r => setTimeout(r, 500));
                
                setProgress(30, 'Downloading GUI files...');
                const downloadResp = await fetch('/api/gui/download', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        repo: 'smrtkrft/LebensSpur',
                        branch: 'main',
                        path: 'GUI'
                    })
                });
                
                if (!downloadResp.ok) {
                    const err = await downloadResp.json();
                    throw new Error(err.error || 'Download failed');
                }
                
                // Poll for progress
                let complete = false;
                while (!complete) {
                    await new Promise(r => setTimeout(r, 1000));
                    const statusResp = await fetch('/api/gui/download/status');
                    const status = await statusResp.json();
                    
                    setProgress(30 + Math.floor(status.progress * 0.5), status.message || 'Downloading...');
                    
                    if (status.state === 'complete') {
                        complete = true;
                    } else if (status.state === 'error') {
                        throw new Error(status.error || 'Download failed');
                    }
                }
                
                // Step 3: Complete setup
                setProgress(90, 'Completing setup...');
                const completeResp = await fetch('/api/setup/complete', {method: 'POST'});
                const completeData = await completeResp.json();
                
                if (!completeData.success) {
                    throw new Error('Failed to complete setup');
                }
                
                // Step 4: Get final device info
                setProgress(95, 'Getting device info...');
                const infoResp = await fetch('/api/device/info');
                const info = await infoResp.json();
                
                // Success!
                setProgress(100, 'Complete!');
                setIcon('success');
                
                // Update success screen
                document.getElementById('finalDeviceId').textContent = info.device_id || 'Unknown';
                document.getElementById('finalWifi').textContent = state.wifiSsid;
                document.getElementById('finalIp').textContent = info.sta_ip || wifiData.ip || 'Unknown';
                document.getElementById('finalMdns').textContent = (info.device_id || 'lebensspur') + '.local';
                
                setTimeout(() => {
                    state.isUpdating = false;
                    state.updateCompleted = true;
                    nextBtn.disabled = false;
                    updateUI();
                }, 1500);
                
            } catch(e) {
                console.error('Update error:', e);
                setIcon('error');
                setProgress(0, 'Error: ' + e.message);
                
                setTimeout(() => {
                    state.isUpdating = false;
                    nextBtn.disabled = false;
                    nextBtn.textContent = 'Retry';
                }, 2000);
            }
        }
    </script>
</body>
</html>
